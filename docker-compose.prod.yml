# TronRelic Production Environment
# Use this for production deployments with optimized builds

version: '3.8'

services:
    # MongoDB Database
    mongodb:
        image: mongo:6
        container_name: tronrelic-mongo-prod
        restart: always
        ports:
            - "27017:27017"
        environment:
            # IMPORTANT: Set these in production!
            - MONGO_INITDB_ROOT_USERNAME=${MONGO_ROOT_USERNAME:-admin}
            - MONGO_INITDB_ROOT_PASSWORD=${MONGO_ROOT_PASSWORD}
        volumes:
            - tronrelic-mongo-prod-data:/data/db
            - tronrelic-mongo-prod-config:/data/configdb
        networks:
            - tronrelic-network
        command: ["mongod", "--auth"]
        healthcheck:
            test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 10s
        logging:
            driver: "json-file"
            options:
                max-size: "10m"
                max-file: "3"

    # Redis Cache and Queue
    redis:
        image: redis:7-alpine
        container_name: tronrelic-redis-prod
        restart: always
        ports:
            - "6379:6379"
        environment:
            # IMPORTANT: Set password in production!
            - REDIS_PASSWORD=${REDIS_PASSWORD}
        volumes:
            - tronrelic-redis-prod-data:/data
        networks:
            - tronrelic-network
        command: ["redis-server", "--requirepass", "${REDIS_PASSWORD}", "--appendonly", "yes"]
        healthcheck:
            test: ["CMD", "redis-cli", "--no-auth-warning", "-a", "${REDIS_PASSWORD}", "ping"]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 5s
        logging:
            driver: "json-file"
            options:
                max-size: "10m"
                max-file: "3"

    # Backend API Server
    backend:
        build:
            context: .
            target: backend
            dockerfile: Dockerfile
        container_name: tronrelic-backend-prod
        restart: always
        ports:
            - "4000:4000"
        environment:
            # Node Environment
            - NODE_ENV=production
            - PORT=4000

            # Database Connections (with authentication)
            - MONGODB_URI=mongodb://${MONGO_ROOT_USERNAME:-admin}:${MONGO_ROOT_PASSWORD}@mongodb:27017/tronrelic?authSource=admin
            - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379

            # Feature Flags
            - ENABLE_SCHEDULER=true
            - ENABLE_WEBSOCKETS=true

            # API Keys (REQUIRED in production)
            - ADMIN_API_TOKEN=${ADMIN_API_TOKEN}
            - TRONGRID_API_KEY=${TRONGRID_API_KEY}
            - TRONGRID_API_KEY_2=${TRONGRID_API_KEY_2}
            - TRONGRID_API_KEY_3=${TRONGRID_API_KEY_3}

            # Optional: Telegram Integration
            - TELEGRAM_WEBHOOK_SECRET=${TELEGRAM_WEBHOOK_SECRET:-}

            # Performance Tuning
            - NODE_OPTIONS=--max-old-space-size=2048
        depends_on:
            mongodb:
                condition: service_healthy
            redis:
                condition: service_healthy
        networks:
            - tronrelic-network
        healthcheck:
            test: ["CMD", "node", "-e", "require('http').get('http://localhost:4000/api/health', (r) => { process.exit(r.statusCode === 200 ? 0 : 1); });"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s
        logging:
            driver: "json-file"
            options:
                max-size: "50m"
                max-file: "5"
        deploy:
            resources:
                limits:
                    cpus: '2.0'
                    memory: 2G
                reservations:
                    cpus: '1.0'
                    memory: 1G

    # Frontend Web Application (Production Mode)
    frontend:
        build:
            context: .
            target: frontend-prod
            dockerfile: Dockerfile
        container_name: tronrelic-frontend-prod
        restart: always
        ports:
            - "3000:3000"
        environment:
            # Next.js Environment
            - NODE_ENV=production

            # API URL for Next.js rewrites (SSR uses Docker service name)
            - API_URL=${API_URL:-http://backend:4000}

            # Client-side API URLs (set via .env for production domain)
            - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://localhost:4000/api}
            - NEXT_PUBLIC_SOCKET_URL=${NEXT_PUBLIC_SOCKET_URL:-http://localhost:4000}
            - NEXT_PUBLIC_SITE_URL=${NEXT_PUBLIC_SITE_URL:-http://localhost:3000}

            # Performance Tuning
            - NODE_OPTIONS=--max-old-space-size=1024
        depends_on:
            backend:
                condition: service_healthy
        networks:
            - tronrelic-network
        healthcheck:
            test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/api/health', (r) => { process.exit(r.statusCode === 200 ? 0 : 1); });"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s
        logging:
            driver: "json-file"
            options:
                max-size: "50m"
                max-file: "5"
        deploy:
            resources:
                limits:
                    cpus: '1.5'
                    memory: 1G
                reservations:
                    cpus: '0.5'
                    memory: 512M

networks:
    tronrelic-network:
        driver: bridge

volumes:
    tronrelic-mongo-prod-data:
        driver: local
    tronrelic-mongo-prod-config:
        driver: local
    tronrelic-redis-prod-data:
        driver: local
