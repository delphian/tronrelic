# TronRelic Dev Server Configuration
# Used for dev.tronrelic.com deployment

services:
    # MongoDB Database
    mongodb:
        image: mongo:6
        container_name: tronrelic-mongo-dev
        restart: unless-stopped
        ports:
            - "27017:27017"
        volumes:
            - tronrelic-mongo-dev-data:/data/db
        networks:
            - tronrelic-network
        healthcheck:
            test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 10s

    # Redis Cache and Queue
    redis:
        image: redis:7-alpine
        container_name: tronrelic-redis-dev
        restart: unless-stopped
        ports:
            - "6379:6379"
        volumes:
            - tronrelic-redis-dev-data:/data
        networks:
            - tronrelic-network
        healthcheck:
            test: ["CMD", "redis-cli", "ping"]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 5s

    # Backend API Server
    backend:
        image: ghcr.io/delphian/tronrelic/backend:dev
        container_name: tronrelic-backend-dev
        restart: unless-stopped
        ports:
            - "4000:4000"
        environment:
            # Node Environment
            - NODE_ENV=development
            - PORT=4000

            # Database Connections (use service names for DNS)
            - MONGODB_URI=mongodb://mongodb:27017/tronrelic
            - REDIS_URL=redis://redis:6379

            # Feature Flags
            - ENABLE_SCHEDULER=true
            - ENABLE_WEBSOCKETS=true

            # API Keys (load from .env file)
            - ADMIN_API_TOKEN=${ADMIN_API_TOKEN}
            - TRONGRID_API_KEY=${TRONGRID_API_KEY}
            - TRONGRID_API_KEY_2=${TRONGRID_API_KEY_2}
            - TRONGRID_API_KEY_3=${TRONGRID_API_KEY_3}

            # Runtime Configuration (see docs/system/system-runtime-config.md)
            # Sets initial database default for siteUrl on fresh install
            # Set via .env file: SITE_URL=https://dev.tronrelic.com
            - NEXT_PUBLIC_SITE_URL=${SITE_URL:-https://dev.tronrelic.com}
        depends_on:
            mongodb:
                condition: service_healthy
            redis:
                condition: service_healthy
        networks:
            - tronrelic-network
        volumes:
            # Mount logs directory for debugging (pre-created via .gitkeep to prevent permission issues)
            - ./.run:/app/.run
            # Mount uploads directory for file persistence across container restarts
            - ./public/uploads:/app/public/uploads
        healthcheck:
            test: ["CMD", "node", "-e", "require('http').get('http://localhost:4000/api/health', (r) => { process.exit(r.statusCode === 200 ? 0 : 1); });"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s

    # Frontend Web Application (Development Mode)
    frontend:
        image: ghcr.io/delphian/tronrelic/frontend:dev
        container_name: tronrelic-frontend-dev
        restart: unless-stopped
        ports:
            - "3000:3000"
        environment:
            # Next.js Environment
            - NODE_ENV=development

            # API URL for Next.js rewrites (SSR uses Docker service name for backend-to-backend communication)
            - API_URL=http://backend:4000

            # NOTE: NEXT_PUBLIC_* variables have been REMOVED
            # Runtime configuration is now fetched from backend's SystemConfigService
            # and injected into HTML by SSR (see lib/serverConfig.ts and lib/runtimeConfig.ts).
            # Administrators configure the site URL via /system/config admin UI.
            #
            # For dev.tronrelic.com deployment:
            # 1. Deploy this docker-compose.dev.yml
            # 2. Visit https://dev.tronrelic.com/system/config
            # 3. Set siteUrl to "https://dev.tronrelic.com"
            # 4. WebSocket will connect to correct domain automatically
            #
            # Benefits:
            # - Same Docker image works for dev.tronrelic.com and tronrelic.com
            # - Runtime reconfiguration without redeployment
            # - Single source of truth (backend database)
        depends_on:
            backend:
                condition: service_healthy
        networks:
            - tronrelic-network
        volumes:
            # Mount logs directory for debugging
            - ./.run:/app/.run

networks:
    tronrelic-network:
        driver: bridge

volumes:
    tronrelic-mongo-dev-data:
        driver: local
    tronrelic-redis-dev-data:
        driver: local
