#!/bin/bash

# Pre-push hook to run tests before pushing to main or dev
# This provides local protection before GitHub branch protection kicks in

# Get the current branch being pushed
current_branch=$(git rev-parse --abbrev-ref HEAD)
remote="$1"
url="$2"

# Check if pushing to main or dev
while read local_ref local_sha remote_ref remote_sha
do
    if [[ "$remote_ref" =~ refs/heads/(main|dev) ]]; then
        echo "ğŸ”’ Pushing to protected branch: $(basename $remote_ref)"
        echo "ğŸ§ª Running tests before push..."

        # Run unit tests
        echo ""
        echo "Running unit tests..."
        if ! npm test; then
            echo "âŒ Unit tests failed! Push aborted."
            echo "Fix the tests or use 'git push --no-verify' to bypass (not recommended)"
            exit 1
        fi

        echo "âœ… Unit tests passed!"
        echo ""
        echo "Note: Integration tests will run in GitHub Actions"
        echo "âœ… Local checks passed, proceeding with push..."
    fi
done

exit 0
