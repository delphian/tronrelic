name: PR Environment

on:
  pull_request:
    branches:
      - dev

jobs:
  build-and-provision:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Sanitize branch name for Docker tag
        id: prep
        run: |
          # Convert branch name to lowercase and replace invalid characters
          BRANCH_NAME="${{ github.head_ref }}"
          SANITIZED_BRANCH=$(echo "$BRANCH_NAME" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9._-]/-/g')
          SHORT_SHA=$(echo "${{ github.event.pull_request.head.sha }}" | cut -c1-7)
          IMAGE_TAG="pr-${SANITIZED_BRANCH}-${SHORT_SHA}"

          echo "branch=$SANITIZED_BRANCH" >> $GITHUB_OUTPUT
          echo "tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push backend image
        run: |
          docker build --target backend \
            -t ghcr.io/${{ github.repository }}/backend:${{ steps.prep.outputs.tag }} \
            .
          docker push ghcr.io/${{ github.repository }}/backend:${{ steps.prep.outputs.tag }}

      - name: Build and push frontend image
        run: |
          docker build --target frontend-prod \
            -t ghcr.io/${{ github.repository }}/frontend:${{ steps.prep.outputs.tag }} \
            .
          docker push ghcr.io/${{ github.repository }}/frontend:${{ steps.prep.outputs.tag }}

      - name: Images built successfully
        run: |
          echo "✅ Pull request Docker images built and pushed to GHCR"
          echo ""
          echo "PR: #${{ github.event.pull_request.number }} - ${{ github.event.pull_request.title }}"
          echo "Source branch: ${{ github.head_ref }}"
          echo "Target branch: dev"
          echo "Image tag: ${{ steps.prep.outputs.tag }}"
          echo ""
          echo "Backend: ghcr.io/${{ github.repository }}/backend:${{ steps.prep.outputs.tag }}"
          echo "Frontend: ghcr.io/${{ github.repository }}/frontend:${{ steps.prep.outputs.tag }}"

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DO_API_TOKEN }}

      - name: Check if droplet already exists
        id: check
        run: |
          DROPLET_NAME="tronrelic-pr-${{ github.event.pull_request.number }}"

          if doctl compute droplet list --format Name --no-header | grep -q "^${DROPLET_NAME}$"; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "⚠️ Droplet $DROPLET_NAME already exists, skipping creation"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "✅ Droplet $DROPLET_NAME does not exist, will create"
          fi

      - name: Create droplet
        if: steps.check.outputs.exists == 'false'
        id: create
        run: |
          DROPLET_NAME="tronrelic-pr-${{ github.event.pull_request.number }}"

          echo "Creating droplet: $DROPLET_NAME"

          doctl compute droplet create "$DROPLET_NAME" \
            --size s-2vcpu-4gb-amd \
            --region sgp1 \
            --image ubuntu-25-04-x64 \
            --ssh-keys ${{ secrets.DO_SSH_KEY_FINGERPRINT }} \
            --wait \
            --format ID,Name,PublicIPv4 \
            --no-header

          echo "✅ Droplet created successfully"

      - name: Get droplet IP
        if: steps.check.outputs.exists == 'false'
        id: ip
        run: |
          DROPLET_NAME="tronrelic-pr-${{ github.event.pull_request.number }}"

          # Wait a moment for droplet to be fully ready
          sleep 10

          DROPLET_IP=$(doctl compute droplet list \
            --format Name,PublicIPv4 \
            --no-header \
            | grep "^${DROPLET_NAME}" \
            | awk '{print $2}')

          if [ -z "$DROPLET_IP" ]; then
            echo "❌ Could not retrieve droplet IP"
            exit 1
          fi

          echo "ip=$DROPLET_IP" >> $GITHUB_OUTPUT
          echo "✅ Droplet IP: $DROPLET_IP"

      - name: Install Docker on droplet
        if: steps.check.outputs.exists == 'false'
        run: |
          DROPLET_IP="${{ steps.ip.outputs.ip }}"

          echo "Setting up SSH key..."
          mkdir -p ~/.ssh
          echo "${{ secrets.DO_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          echo "Waiting for SSH to become available..."
          MAX_ATTEMPTS=30
          ATTEMPT=0

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            if ssh -o ConnectTimeout=5 -o StrictHostKeyChecking=no root@"$DROPLET_IP" "echo 'SSH Ready'" 2>/dev/null; then
              echo "✅ SSH connection established"
              break
            fi

            ATTEMPT=$((ATTEMPT + 1))
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS - waiting 10s..."
            sleep 10
          done

          if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
            echo "❌ SSH did not become available in time"
            exit 1
          fi

          echo "Adding droplet to known_hosts..."
          ssh-keyscan -H "$DROPLET_IP" >> ~/.ssh/known_hosts

          echo "Installing Docker and dependencies..."
          ssh root@"$DROPLET_IP" << 'EOF'
            set -e

            # Update package index
            apt-get update

            # Install prerequisites
            apt-get install -y \
              ca-certificates \
              curl \
              gnupg \
              lsb-release

            # Add Docker's official GPG key
            install -m 0755 -d /etc/apt/keyrings
            curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
            chmod a+r /etc/apt/keyrings/docker.asc

            # Add Docker repository
            echo \
              "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
              $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
              tee /etc/apt/sources.list.d/docker.list > /dev/null

            # Install Docker Engine
            apt-get update
            apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

            # Start and enable Docker
            systemctl start docker
            systemctl enable docker

            # Create deployment directory
            mkdir -p /opt/tronrelic

            # Verify installation
            docker --version
            docker compose version

            echo "✅ Docker installation complete"
          EOF

          echo "✅ Droplet setup complete"

      - name: Copy docker-compose.yml to droplet
        if: steps.check.outputs.exists == 'false'
        run: |
          DROPLET_IP="${{ steps.ip.outputs.ip }}"
          DEPLOY_DIR="/opt/tronrelic"

          echo "Copying docker-compose.yml to droplet..."
          scp -o StrictHostKeyChecking=no \
            docker-compose.yml \
            root@"$DROPLET_IP":"$DEPLOY_DIR/"

          echo "✅ Docker compose configuration copied"

          # Verify it exists
          ssh -o StrictHostKeyChecking=no root@"$DROPLET_IP" \
            "ls -lh $DEPLOY_DIR/docker-compose.yml"

      - name: Create .env file on droplet
        if: steps.check.outputs.exists == 'false'
        run: |
          DROPLET_IP="${{ steps.ip.outputs.ip }}"
          DEPLOY_DIR="/opt/tronrelic"
          IMAGE_TAG="${{ steps.prep.outputs.tag }}"
          ADMIN_TOKEN="${{ secrets.ADMIN_API_TOKEN }}"
          TRONGRID_KEY_1="${{ secrets.TRONGRID_API_KEY }}"
          TRONGRID_KEY_2="${{ secrets.TRONGRID_API_KEY_2 }}"
          TRONGRID_KEY_3="${{ secrets.TRONGRID_API_KEY_3 }}"

          echo "Generating secure secrets..."
          MONGO_PASSWORD=$(openssl rand -hex 32)
          REDIS_PASSWORD=$(openssl rand -hex 32)

          echo "Creating .env file..."
          {
            echo "# TronRelic PR Environment - Auto-generated by GitHub Actions"
            echo "ENV=development"
            echo "SITE_URL=http://$DROPLET_IP:3000"
            echo "SITE_WS=http://$DROPLET_IP:4000"
            echo "SITE_BACKEND=http://backend:4000"
            echo "ADMIN_API_TOKEN=$ADMIN_TOKEN"
            echo "TRONGRID_API_KEY=$TRONGRID_KEY_1"
            echo "TRONGRID_API_KEY_2=$TRONGRID_KEY_2"
            echo "TRONGRID_API_KEY_3=$TRONGRID_KEY_3"
            echo "MONGO_ROOT_USERNAME=admin"
            echo "MONGO_ROOT_PASSWORD=$MONGO_PASSWORD"
            echo "REDIS_PASSWORD=$REDIS_PASSWORD"
            echo "PORT=4000"
            echo "ENABLE_SCHEDULER=true"
            echo "ENABLE_WEBSOCKETS=true"
            echo "REDIS_NAMESPACE=tronrelic"
            echo "IMAGE_TAG=$IMAGE_TAG"
          } > /tmp/pr.env

          scp -o StrictHostKeyChecking=no /tmp/pr.env root@"$DROPLET_IP":"$DEPLOY_DIR/.env"
          ssh -o StrictHostKeyChecking=no root@"$DROPLET_IP" "chmod 600 $DEPLOY_DIR/.env && ls -lh $DEPLOY_DIR/.env"
          rm /tmp/pr.env

          echo "✅ Environment file created"

      - name: Authenticate with GitHub Container Registry
        if: steps.check.outputs.exists == 'false'
        run: |
          DROPLET_IP="${{ steps.ip.outputs.ip }}"

          echo "Authenticating with GHCR on droplet..."
          echo "${{ secrets.GITHUB_TOKEN }}" | ssh -o StrictHostKeyChecking=no root@"$DROPLET_IP" \
            "docker login ghcr.io -u ${{ github.actor }} --password-stdin"

          echo "✅ GHCR authentication successful"

      - name: Pull Docker images
        if: steps.check.outputs.exists == 'false'
        run: |
          DROPLET_IP="${{ steps.ip.outputs.ip }}"
          DEPLOY_DIR="/opt/tronrelic"
          IMAGE_TAG="${{ steps.prep.outputs.tag }}"

          echo "Pulling Docker images with tag: $IMAGE_TAG"
          echo "This may take several minutes..."

          ssh -o StrictHostKeyChecking=no root@"$DROPLET_IP" \
            "cd $DEPLOY_DIR && docker compose pull"

          echo "✅ Docker images pulled successfully"

      - name: Start containers
        if: steps.check.outputs.exists == 'false'
        run: |
          DROPLET_IP="${{ steps.ip.outputs.ip }}"
          DEPLOY_DIR="/opt/tronrelic"

          echo "Starting containers..."
          ssh -o StrictHostKeyChecking=no root@"$DROPLET_IP" \
            "cd $DEPLOY_DIR && docker compose up -d"

          echo "Waiting for containers to start (30 seconds)..."
          sleep 30

          echo "Checking container status..."
          ssh -o StrictHostKeyChecking=no root@"$DROPLET_IP" \
            "cd $DEPLOY_DIR && docker compose ps"

          echo "✅ Containers started successfully"

      - name: Post success comment on PR
        if: steps.check.outputs.exists == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ github.event.pull_request.number }};
            const dropletIp = '${{ steps.ip.outputs.ip }}';
            const imageTag = '${{ steps.prep.outputs.tag }}';
            const backendImage = `ghcr.io/${{ github.repository }}/backend:${imageTag}`;
            const frontendImage = `ghcr.io/${{ github.repository }}/frontend:${imageTag}`;

            const comment = `## ✅ Environment provisioned for PR #${prNumber}

            **Droplet Information:**
            - **Name:** \`tronrelic-pr-${prNumber}\`
            - **IP Address:** \`${dropletIp}\`
            - **Expected DNS:** \`pr-${prNumber}.dev.tronrelic.com\`

            **Docker Images:**
            - **Backend:** \`${backendImage}\`
            - **Frontend:** \`${frontendImage}\`

            **SSH Access:**
            \`\`\`bash
            ssh root@${dropletIp}
            \`\`\`

            **Setup Status:**
            - ✅ Ubuntu 25.04 droplet created
            - ✅ Docker and docker-compose installed
            - ✅ Deployment directory created (\`/opt/tronrelic\`)
            - ✅ Docker images pulled and containers started

            **Access Application:**
            - **Frontend:** http://${dropletIp}:3000
            - **Backend API:** http://${dropletIp}:4000/api
            - **System Monitor:** http://${dropletIp}:3000/system

            **Note:** Direct port access (no nginx). Containers may take 1-2 minutes to fully start.
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: comment
            });

      - name: Post already exists comment on PR
        if: steps.check.outputs.exists == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ github.event.pull_request.number }};
            const imageTag = '${{ steps.prep.outputs.tag }}';
            const backendImage = `ghcr.io/${{ github.repository }}/backend:${imageTag}`;
            const frontendImage = `ghcr.io/${{ github.repository }}/frontend:${imageTag}`;

            const comment = `## ⚠️ Environment already exists for PR #${prNumber}

            Droplet \`tronrelic-pr-${prNumber}\` is already running. Skipping creation.

            **New Docker Images Built:**
            - **Backend:** \`${backendImage}\`
            - **Frontend:** \`${frontendImage}\`

            If you need to recreate the environment, manually destroy the droplet first:
            \`\`\`bash
            doctl compute droplet delete tronrelic-pr-${prNumber} --force
            \`\`\`
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: comment
            });
