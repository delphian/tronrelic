# TronRelic Development Environment
# Use this for local development with hot reloading

services:
    # MongoDB Database
    mongodb:
        image: mongo:6
        container_name: tronrelic-mongo
        restart: unless-stopped
        ports:
            - "27017:27017"
        volumes:
            - tronrelic-mongo-data:/data/db
        networks:
            - tronrelic-network
        healthcheck:
            test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 10s

    # Redis Cache and Queue
    redis:
        image: redis:7-alpine
        container_name: tronrelic-redis
        restart: unless-stopped
        ports:
            - "6379:6379"
        volumes:
            - tronrelic-redis-data:/data
        networks:
            - tronrelic-network
        healthcheck:
            test: ["CMD", "redis-cli", "ping"]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 5s

    # Backend API Server
    backend:
        build:
            context: .
            target: backend
            dockerfile: Dockerfile
        container_name: tronrelic-backend
        restart: unless-stopped
        ports:
            - "4000:4000"
        environment:
            # Node Environment
            - NODE_ENV=development
            - PORT=4000

            # Database Connections (use service names for DNS)
            - MONGODB_URI=mongodb://mongodb:27017/tronrelic
            - REDIS_URL=redis://redis:6379

            # Feature Flags
            - ENABLE_SCHEDULER=true
            - ENABLE_WEBSOCKETS=true

            # API Keys (load from .env file)
            - ADMIN_API_TOKEN=${ADMIN_API_TOKEN}
            - TRONGRID_API_KEY=${TRONGRID_API_KEY}
            - TRONGRID_API_KEY_2=${TRONGRID_API_KEY_2}
            - TRONGRID_API_KEY_3=${TRONGRID_API_KEY_3}

            # Optional: Telegram Integration
            - TELEGRAM_WEBHOOK_SECRET=${TELEGRAM_WEBHOOK_SECRET:-}
        depends_on:
            mongodb:
                condition: service_healthy
            redis:
                condition: service_healthy
        networks:
            - tronrelic-network
        volumes:
            # Mount logs directory for debugging (pre-created via .gitkeep to prevent permission issues)
            - ./.run:/app/.run
        healthcheck:
            test: ["CMD", "node", "-e", "require('http').get('http://localhost:4000/api/health', (r) => { process.exit(r.statusCode === 200 ? 0 : 1); });"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s

    # Frontend Web Application (Development Mode)
    frontend:
        build:
            context: .
            target: frontend-dev
            dockerfile: Dockerfile
        container_name: tronrelic-frontend
        restart: unless-stopped
        ports:
            - "3000:3000"
        environment:
            # Next.js Environment
            - NODE_ENV=development

            # API URL for Next.js rewrites (SSR uses Docker service name)
            - API_URL=http://backend:4000

            # Client-side API URLs (browser accessible)
            - NEXT_PUBLIC_API_URL=http://localhost:4000/api
            - NEXT_PUBLIC_SOCKET_URL=http://localhost:4000
            - NEXT_PUBLIC_SITE_URL=http://localhost:3000
        depends_on:
            backend:
                condition: service_healthy
        networks:
            - tronrelic-network
        volumes:
            # Mount source for hot reloading in dev mode
            - ./apps/frontend/app:/app/apps/frontend/app
            - ./apps/frontend/components:/app/apps/frontend/components
            - ./apps/frontend/features:/app/apps/frontend/features
            - ./apps/frontend/lib:/app/apps/frontend/lib
            # Preserve node_modules
            - /app/node_modules
            - /app/apps/frontend/node_modules
            # Mount logs directory for debugging (pre-created via .gitkeep to prevent permission issues)
            - ./.run:/app/.run

networks:
    tronrelic-network:
        driver: bridge

volumes:
    tronrelic-mongo-data:
        driver: local
    tronrelic-redis-data:
        driver: local
