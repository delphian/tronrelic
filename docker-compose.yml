# TronRelic Universal Docker Compose Configuration
# Works for both development and production environments
# Environment differentiation via ENV variable in .env file
# All images use :production tag; runtime behavior controlled by ENV
#
# Required .env variables:
# - GITHUB_USERNAME: Your GitHub username (for GHCR image paths)
# - IMAGE_TAG: Docker image tag (defaults to 'production')
# - ENV: Environment type (development or production)
#
# SECURITY CRITICAL: Docker bypasses UFW firewall rules!
# - Application ports MUST bind to 127.0.0.1 (localhost only)
# - Database ports MUST NOT be published (Docker network only)
# - Never expose ports without 127.0.0.1 prefix in production

services:
    # MongoDB Database
    mongodb:
        image: mongo:6
        container_name: tronrelic-mongo
        restart: always
        # No ports published - accessible only via Docker network (more secure)
        # For local access: docker exec -it tronrelic-mongo mongosh
        # ports:
        #     - "27017:27017"  # SECURITY: Do not expose - Docker bypasses UFW!
        environment:
            - MONGO_INITDB_ROOT_USERNAME=${MONGO_ROOT_USERNAME}
            - MONGO_INITDB_ROOT_PASSWORD=${MONGO_ROOT_PASSWORD}
        volumes:
            - tronrelic-mongo-data:/data/db
        networks:
            - tronrelic-network
        command: ["mongod", "--auth"]
        healthcheck:
            test: |
                mongosh --username ${MONGO_ROOT_USERNAME} --password ${MONGO_ROOT_PASSWORD} --authenticationDatabase admin --eval "db.adminCommand('ping')"
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 10s

    # Redis Cache and Queue
    redis:
        image: redis:7-alpine
        container_name: tronrelic-redis
        restart: always
        # No ports published - accessible only via Docker network (more secure)
        # For local access: docker exec -it tronrelic-redis redis-cli
        # ports:
        #     - "6379:6379"  # SECURITY: Do not expose - Docker bypasses UFW!
        environment:
            - REDIS_PASSWORD=${REDIS_PASSWORD}
        volumes:
            - tronrelic-redis-data:/data
        networks:
            - tronrelic-network
        command: >
            redis-server --requirepass ${REDIS_PASSWORD} --appendonly yes
        healthcheck:
            test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 5s

    # ClickHouse Analytical Database
    # Used for time-series data, aggregations, and high-volume analytics
    # Container starts automatically; backend connects only if CLICKHOUSE_HOST is set in .env
    clickhouse:
        image: clickhouse/clickhouse-server:24.3
        container_name: tronrelic-clickhouse
        restart: always
        # No ports published - accessible only via Docker network (more secure)
        # For local access: docker exec -it tronrelic-clickhouse clickhouse-client
        # ports:
        #     - "8123:8123"  # SECURITY: Do not expose - Docker bypasses UFW!
        #     - "9000:9000"  # Native TCP protocol
        environment:
            - CLICKHOUSE_DB=tronrelic
            - CLICKHOUSE_USER=${CLICKHOUSE_USER:-default}
            - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD:-}
            - CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT=1
        volumes:
            - tronrelic-clickhouse-data:/var/lib/clickhouse
            - tronrelic-clickhouse-logs:/var/log/clickhouse-server
        networks:
            - tronrelic-network
        ulimits:
            nofile:
                soft: 262144
                hard: 262144
        healthcheck:
            test: ["CMD", "clickhouse-client", "--query", "SELECT 1"]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 10s

    # Backend API Server
    backend:
        image: ghcr.io/${GITHUB_USERNAME}/tronrelic-backend:${IMAGE_TAG:-production}
        container_name: tronrelic-backend
        restart: always
        ports:
            # Bind to localhost only - accessible to Nginx but not external connections
            # Docker bypasses UFW, so binding to 127.0.0.1 is critical for security
            - "127.0.0.1:4000:4000"
        environment:
            # Node Environment (unified with image tag)
            - NODE_ENV=${ENV}
            - PORT=4000

            # Database Connections (authenticated)
            - MONGODB_URI=mongodb://${MONGO_ROOT_USERNAME}:${MONGO_ROOT_PASSWORD}@mongodb:27017/tronrelic?authSource=admin
            - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379
            - REDIS_NAMESPACE=tronrelic

            # Feature Flags
            - ENABLE_SCHEDULER=${ENABLE_SCHEDULER}
            - ENABLE_WEBSOCKETS=${ENABLE_WEBSOCKETS}

            # API Keys
            - ADMIN_API_TOKEN=${ADMIN_API_TOKEN}
            - TRONGRID_API_KEY=${TRONGRID_API_KEY}
            - TRONGRID_API_KEY_2=${TRONGRID_API_KEY_2}
            - TRONGRID_API_KEY_3=${TRONGRID_API_KEY_3}

            # Site Configuration
            - SITE_URL=${SITE_URL}
            - SITE_WS=${SITE_WS}

            # ClickHouse (analytical workloads)
            - CLICKHOUSE_HOST=http://clickhouse:8123
            - CLICKHOUSE_DATABASE=tronrelic
            - CLICKHOUSE_USER=${CLICKHOUSE_USER:-default}
            - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD:-}
        depends_on:
            mongodb:
                condition: service_healthy
            redis:
                condition: service_healthy
        networks:
            - tronrelic-network
        volumes:
            # Mount logs directory for debugging
            - ./.run:/app/.run
            # Mount uploads directory for file persistence
            - ./public/uploads:/app/public/uploads
        healthcheck:
            test: ["CMD", "node", "-e", "require('http').get('http://localhost:4000/api/health', (r) => { process.exit(r.statusCode === 200 ? 0 : 1); });"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s
        logging:
            driver: "json-file"
            options:
                max-size: "50m"
                max-file: "5"

    # Frontend Web Application
    frontend:
        image: ghcr.io/${GITHUB_USERNAME}/tronrelic-frontend:${IMAGE_TAG:-production}
        container_name: tronrelic-frontend
        restart: always
        ports:
            # Bind to localhost only - accessible to Nginx but not external connections
            # Docker bypasses UFW, so binding to 127.0.0.1 is critical for security
            - "127.0.0.1:3000:3000"
        environment:
            # Node Environment (unified with image tag)
            - NODE_ENV=${ENV}

            # Backend URL for SSR (reads from .env: http://backend:4000 for Docker, http://localhost:4000 for local)
            - SITE_BACKEND=${SITE_BACKEND}

            # NOTE: NEXT_PUBLIC_* variables removed
            # Runtime config is fetched from backend API and injected via SSR
            # See docs/system/system-runtime-config.md for details
        depends_on:
            backend:
                condition: service_healthy
        networks:
            - tronrelic-network
        volumes:
            # Mount logs directory for debugging
            - ./.run:/app/.run
        logging:
            driver: "json-file"
            options:
                max-size: "10m"
                max-file: "3"

networks:
    tronrelic-network:
        driver: bridge

volumes:
    tronrelic-mongo-data:
        driver: local
    tronrelic-redis-data:
        driver: local
    tronrelic-clickhouse-data:
        driver: local
    tronrelic-clickhouse-logs:
        driver: local