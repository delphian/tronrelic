# TronRelic Development Environment - Minimal Stack
# Use this for npm-based local development (MongoDB + Redis only)
# Backend and frontend run via npm on the host for faster development

services:
    # MongoDB Database
    mongodb:
        image: mongo:6
        container_name: tronrelic-mongo
        restart: unless-stopped
        ports:
            - "27017:27017"
        volumes:
            - tronrelic-mongo-data:/data/db
        networks:
            - tronrelic-network
        healthcheck:
            test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 10s

    # Redis Cache and Queue
    redis:
        image: redis:7-alpine
        container_name: tronrelic-redis
        restart: unless-stopped
        ports:
            - "6379:6379"
        volumes:
            - tronrelic-redis-data:/data
        networks:
            - tronrelic-network
        healthcheck:
            test: ["CMD", "redis-cli", "ping"]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 5s

    # ClickHouse Analytical Database
    clickhouse:
        image: clickhouse/clickhouse-server:24.3
        container_name: tronrelic-clickhouse
        restart: unless-stopped
        ports:
            - "8123:8123"
        environment:
            - CLICKHOUSE_DB=tronrelic
            - CLICKHOUSE_USER=default
            - CLICKHOUSE_PASSWORD=
            - CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT=1
        volumes:
            - tronrelic-clickhouse-data:/var/lib/clickhouse
        networks:
            - tronrelic-network
        ulimits:
            nofile:
                soft: 262144
                hard: 262144
        healthcheck:
            test: ["CMD", "clickhouse-client", "--user", "${CLICKHOUSE_USER:-default}", "--password", "${CLICKHOUSE_PASSWORD:-}", "--query", "SELECT 1"]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 10s

networks:
    tronrelic-network:
        driver: bridge

volumes:
    tronrelic-mongo-data:
        driver: local
    tronrelic-redis-data:
        driver: local
    tronrelic-clickhouse-data:
        driver: local
